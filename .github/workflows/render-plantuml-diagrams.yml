# SPDX-FileCopyrightText: 2025 Swiss Confederation
#
# SPDX-License-Identifier: MIT

name: Render PlantUML Diagrams

permissions:
  contents: read

on:
  push:
    paths:
      # PREREQ plantuml-generator-maven-plugin is already configured in pom.xml w.r.t.
      #        https://devlauer.github.io/plantuml-generator/plantuml-generator-maven-plugin/latest/class-diagram/examples.html
      - '**/*.puml'
  workflow_dispatch:

jobs:
  plantuml:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push changes back to the repository
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Install GraphViz
        run: sudo apt-get update && sudo apt-get install -y graphviz

      - name: Download PlantUML jar
        run: curl -L -o plantuml.jar https://github.com/plantuml/plantuml/releases/download/v1.2025.10/plantuml-1.2025.10.jar

      # Optionally check the SHA256 checksum to avoid corrupt downloads
      # - name: Verify PlantUML jar checksum
      #   run: echo "<expected_sha256_here>  plantuml.jar" | sha256sum -c -

      - name: Render .puml to .svg
        run: |
          find . -name '*.puml' -exec java -jar plantuml.jar -tsvg -o . {} +

      - name: Commit rendered diagrams
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git status
          git add **/*.svg

          if git diff --cached --quiet; then
            echo "No diagram changes to commit."
          else
            #git commit -m "docs: auto-rendered PlantUML diagrams"
            #git push
          fi